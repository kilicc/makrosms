generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username                String           @unique @db.VarChar(30)
  email                   String           @unique @db.VarChar(255)
  passwordHash            String           @map("password_hash") @db.VarChar(255)
  credit                  Int?             @default(0)
  isVerified              Boolean?         @default(false) @map("is_verified")
  role                    String?          @default("user") @db.VarChar(20)
  twoFactorEnabled        Boolean?         @default(false) @map("two_factor_enabled")
  twoFactorSecret         String?          @map("two_factor_secret") @db.VarChar(255)
  lastLogin               DateTime?        @map("last_login") @db.Timestamptz(6)
  createdAt               DateTime?        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime?        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  contactGroups           ContactGroup[]
  contacts                Contact[]
  approvedPaymentRequests PaymentRequest[] @relation("PaymentRequestApprover")
  paymentRequests         PaymentRequest[]
  payments                Payment[]
  refunds                 Refund[]
  smsMessages             SmsMessage[]
  smsTemplates            SmsTemplate[]
  apiKeys                 ApiKey[]
  shortLinks              ShortLink[]

  @@index([email], map: "idx_users_email")
  @@index([username], map: "idx_users_username")
  @@map("users")
}

model ContactGroup {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String?   @map("user_id") @db.Uuid
  name         String    @db.VarChar(50)
  description  String?
  color        String?   @default("#1976d2") @db.VarChar(7)
  icon         String?   @default("group") @db.VarChar(50)
  isDefault    Boolean?  @default(false) @map("is_default")
  isActive     Boolean?  @default(true) @map("is_active")
  contactCount Int?      @default(0) @map("contact_count")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user         User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  contacts     Contact[]

  @@unique([userId, name])
  @@index([userId], map: "idx_contact_groups_user_id")
  @@map("contact_groups")
}

model Contact {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String?       @map("user_id") @db.Uuid
  groupId       String?       @map("group_id") @db.Uuid
  name          String        @db.VarChar(100)
  phone         String        @db.VarChar(20)
  email         String?       @db.VarChar(255)
  notes         String?
  tags          String[]
  isActive      Boolean?      @default(true) @map("is_active")
  isBlocked     Boolean?      @default(false) @map("is_blocked")
  lastContacted DateTime?     @map("last_contacted") @db.Timestamptz(6)
  contactCount  Int?          @default(0) @map("contact_count")
  createdAt     DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  group         ContactGroup? @relation(fields: [groupId], references: [id], onUpdate: NoAction)
  user          User?         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  smsMessages   SmsMessage[]

  @@unique([userId, phone])
  @@index([groupId], map: "idx_contacts_group_id")
  @@index([phone], map: "idx_contacts_phone")
  @@index([userId], map: "idx_contacts_user_id")
  @@map("contacts")
}

model SmsMessage {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String?   @map("user_id") @db.Uuid
  contactId       String?   @map("contact_id") @db.Uuid
  phoneNumber     String    @map("phone_number") @db.VarChar(20)
  message         String
  sender          String?   @db.VarChar(50)
  status          String?   @default("sent") @db.VarChar(20)
  cost            Decimal?  @default(0) @db.Decimal(10, 2)
  serviceName     String?   @map("service_name") @db.VarChar(50)
  serviceCode     String?   @map("service_code") @db.VarChar(20)
  serviceUrl      String?   @map("service_url")
  cepSmsMessageId String?   @map("cep_sms_message_id") @db.VarChar(100)
  network         String?   @db.VarChar(50)
  sentAt          DateTime? @default(now()) @map("sent_at") @db.Timestamptz(6)
  deliveredAt     DateTime? @map("delivered_at") @db.Timestamptz(6)
  failedAt        DateTime? @map("failed_at") @db.Timestamptz(6)
  refundProcessed Boolean?  @default(false) @map("refund_processed")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  refunds         Refund[]
  contact         Contact?  @relation(fields: [contactId], references: [id], onUpdate: NoAction)
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([phoneNumber], map: "idx_sms_messages_phone")
  @@index([sentAt], map: "idx_sms_messages_sent_at")
  @@index([status], map: "idx_sms_messages_status")
  @@index([userId], map: "idx_sms_messages_user_id")
  @@map("sms_messages")
}

model SmsTemplate {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String?   @map("user_id") @db.Uuid
  name       String    @db.VarChar(100)
  content    String
  category   String?   @default("Genel") @db.VarChar(50)
  variables  String[]
  isActive   Boolean?  @default(true) @map("is_active")
  usageCount Int?      @default(0) @map("usage_count")
  lastUsed   DateTime? @map("last_used") @db.Timestamptz(6)
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, name])
  @@index([category], map: "idx_sms_templates_category")
  @@index([usageCount], map: "idx_sms_templates_usage_count")
  @@index([userId], map: "idx_sms_templates_user_id")
  @@map("sms_templates")
}

model Refund {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String?     @map("user_id") @db.Uuid
  smsId          String?     @map("sms_id") @db.Uuid
  originalCost   Decimal     @map("original_cost") @db.Decimal(10, 2)
  refundAmount   Decimal     @map("refund_amount") @db.Decimal(10, 2)
  reason         String      @db.VarChar(255)
  status         String?     @default("pending") @db.VarChar(20)
  hoursWaited    Decimal?    @map("hours_waited") @db.Decimal(5, 1)
  remainingHours Decimal?    @map("remaining_hours") @db.Decimal(5, 1)
  createdAt      DateTime?   @default(now()) @map("created_at") @db.Timestamptz(6)
  processedAt    DateTime?   @map("processed_at") @db.Timestamptz(6)
  sms            SmsMessage? @relation(fields: [smsId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user           User?       @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([status], map: "idx_refunds_status")
  @@index([userId], map: "idx_refunds_user_id")
  @@map("refunds")
}

model Payment {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String?   @map("user_id") @db.Uuid
  amount        Decimal   @db.Decimal(10, 2)
  currency      String?   @default("TRY") @db.VarChar(10)
  paymentMethod String?   @map("payment_method") @db.VarChar(50)
  transactionId String?   @map("transaction_id") @db.VarChar(255)
  status        String?   @default("pending") @db.VarChar(20)
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt   DateTime? @map("completed_at") @db.Timestamptz(6)
  user          User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([status], map: "idx_payments_status")
  @@index([userId], map: "idx_payments_user_id")
  @@map("payments")
}

model PaymentRequest {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String?   @map("user_id") @db.Uuid
  amount          Decimal   @db.Decimal(10, 2)
  currency        String?   @default("TRY") @db.VarChar(10)
  paymentMethod   String?   @map("payment_method") @db.VarChar(50)
  credits         Int       @default(0)
  bonus           Int?      @default(0)
  description     String?   @db.VarChar(500)
  transactionId   String?   @map("transaction_id") @db.VarChar(255)
  status          String?   @default("pending") @db.VarChar(20)
  adminNotes      String?   @map("admin_notes")
  approvedBy      String?   @map("approved_by") @db.Uuid
  approvedAt      DateTime? @map("approved_at") @db.Timestamptz(6)
  rejectedAt      DateTime? @map("rejected_at") @db.Timestamptz(6)
  rejectionReason String?   @map("rejection_reason") @db.VarChar(500)
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  approver        User?     @relation("PaymentRequestApprover", fields: [approvedBy], references: [id], onUpdate: NoAction)
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([status], map: "idx_payment_requests_status")
  @@index([userId], map: "idx_payment_requests_user_id")
  @@index([createdAt], map: "idx_payment_requests_created_at")
  @@map("payment_requests")
}

model PaymentPackage {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  packageId    String    @unique @map("package_id") @db.VarChar(50)
  name         String    @db.VarChar(100)
  credits      Int       @default(0)
  price        Decimal   @db.Decimal(10, 2)
  currency     String?   @default("TRY") @db.VarChar(10)
  bonus        Int?      @default(0)
  isActive     Boolean?  @default(true) @map("is_active")
  displayOrder Int?      @default(0) @map("display_order")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive], map: "idx_payment_packages_is_active")
  @@index([displayOrder], map: "idx_payment_packages_display_order")
  @@map("payment_packages")
}

model CryptoCurrency {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  symbol        String    @unique @db.VarChar(10)
  name          String    @db.VarChar(100)
  decimals      Int       @default(8)
  minAmount     Decimal   @map("min_amount") @db.Decimal(20, 8)
  networkFee    Decimal   @map("network_fee") @db.Decimal(20, 8)
  confirmations Int       @default(3)
  walletAddress String?   @map("wallet_address") @db.VarChar(255)
  isActive      Boolean?  @default(true) @map("is_active")
  displayOrder  Int?      @default(0) @map("display_order")
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive], map: "idx_crypto_currencies_is_active")
  @@index([displayOrder], map: "idx_crypto_currencies_display_order")
  @@map("crypto_currencies")
}

model ApiKey {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  keyName     String?   @map("key_name") @db.VarChar(100)
  apiKey      String    @unique @map("api_key") @db.VarChar(255)
  apiSecret   String    @map("api_secret") @db.VarChar(255)
  description String?
  isActive    Boolean?  @default(true) @map("is_active")
  lastUsedAt  DateTime? @map("last_used_at") @db.Timestamptz(6)
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId], map: "idx_api_keys_user_id")
  @@index([apiKey], map: "idx_api_keys_api_key")
  @@index([isActive], map: "idx_api_keys_is_active")
  @@map("api_keys")
}

model ShortLink {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String?         @map("user_id") @db.Uuid
  originalUrl     String          @map("original_url")
  shortCode       String          @unique @map("short_code") @db.VarChar(50)
  title           String?         @db.VarChar(255)
  description     String?
  clickCount      Int?            @default(0) @map("click_count")
  uniqueClickCount Int?           @default(0) @map("unique_click_count")
  isActive        Boolean?        @default(true) @map("is_active")
  expiresAt       DateTime?       @map("expires_at") @db.Timestamptz(6)
  createdAt       DateTime?       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime?       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user            User?           @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  clicks          ShortLinkClick[]

  @@index([userId], map: "idx_short_links_user_id")
  @@index([shortCode], map: "idx_short_links_short_code")
  @@index([isActive], map: "idx_short_links_is_active")
  @@map("short_links")
}

model ShortLinkClick {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shortLinkId String     @map("short_link_id") @db.Uuid
  ipAddress   String?    @map("ip_address") @db.VarChar(45)
  userAgent   String?    @map("user_agent")
  referer     String?
  country     String?    @db.VarChar(100)
  city        String?    @db.VarChar(100)
  clickedAt   DateTime?  @default(now()) @map("clicked_at") @db.Timestamptz(6)
  shortLink   ShortLink  @relation(fields: [shortLinkId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([shortLinkId], map: "idx_short_link_clicks_short_link_id")
  @@index([clickedAt], map: "idx_short_link_clicks_clicked_at")
  @@index([ipAddress], map: "idx_short_link_clicks_ip_address")
  @@map("short_link_clicks")
}
